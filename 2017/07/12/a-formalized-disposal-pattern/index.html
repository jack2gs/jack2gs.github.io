<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Fintech, Jack" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="理解IDisposable.Dispose()和Object.Finalize()        /* @licstart  The following is the entire license notice for the JavaScript code in this tag.  Copyright (C) 2012-2017 Free Software Foundation,">
<meta property="og:type" content="article">
<meta property="og:title" content="Jack Gao&#39;s Blog">
<meta property="og:url" content="jack2gs.github.io/2017/07/12/a-formalized-disposal-pattern/index.html">
<meta property="og:site_name" content="Jack Gao&#39;s Blog">
<meta property="og:description" content="理解IDisposable.Dispose()和Object.Finalize()        /* @licstart  The following is the entire license notice for the JavaScript code in this tag.  Copyright (C) 2012-2017 Free Software Foundation,">
<meta property="og:updated_time" content="2017-07-12T12:04:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jack Gao&#39;s Blog">
<meta name="twitter:description" content="理解IDisposable.Dispose()和Object.Finalize()        /* @licstart  The following is the entire license notice for the JavaScript code in this tag.  Copyright (C) 2012-2017 Free Software Foundation,">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="jack2gs.github.io/2017/07/12/a-formalized-disposal-pattern/"/>






  <title> | Jack Gao's Blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jack Gao's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Road & Book</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="jack2gs.github.io/2017/07/12/a-formalized-disposal-pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Gao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jack Gao's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline"></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-12T20:04:45+08:00">
                2017-07-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-07-12T20:04:45+08:00">
                2017-07-12
              </time>
            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-07-12 Wed 20:04 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>理解IDisposable.Dispose()和Object.Finalize()</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Gao Song">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">理解IDisposable.Dispose()和Object.Finalize()</h1>
<p>
说到内存管理，C\C++的开发人员肯定遇到过各种各样令人头疼的内存管理问题，以及复杂的指针问题。而相比较而言，Java和C#的开发人员就幸福多了，这两种语言都提供了垃圾回收机制，这极大地减轻了开发人员的内存管理工作。垃圾回收由运行时负责，大部分时间开发人员都不需要开关注此类问题。但是，大部分时间并不是所有时间，例如C#当涉及到非托管的资源时，就需要开发人员自己处理。而 <code>IDisposable.Dispose()</code> 和 <code>Object.Finalize()</code> 就是其中重要的两个方法。本文主要介绍下二者的使用方法、区别与联系和最佳实践。
</p>
<a id="more"></a>

<div id="outline-container-orgf6ff82d" class="outline-2">
<h2 id="orgf6ff82d"><span class="section-number-2">1</span> 引言</h2>
<div class="outline-text-2" id="text-1">
<p>
.NET中主要有两种资源：托管的资源和非托管的资源。顾名思义，托管的资源由.NET运行时管理，非托管的资源由开发人员管理。
</p>

<p>
托管资源指的是.NET可以自动进行回收的资源，主要是指托管堆上分配的内存资源。托管资源的回收工作是不需要人工干预的，由.NET运行时在合适的时机调用垃圾回收器进行回收。
</p>

<p>
非托管资源指的是.NET不知道如何回收的资源，最常见的一类非托管资源是包装操作系统资源的对象，例如文件，窗口，网络连接，数据库连接，画刷，图标等。这类资源，垃圾回收器在清理的时候会调用 <code>Object.Finalize()</code> 方法。默认情况下，方法是空的，对于非托管对象，需要在此方法中编写回收非托管资源的代码，以便垃圾回收器正确回收资源。
</p>

<p>
但是有些非托管资源往往比较宝贵，而垃圾回收是由.NET运行时执行的。这样就无法保证及时地释放掉这些资源。鉴于此，.NET提供了 <code>IDisposeable</code> 接口。凡是实现了该接口的对象，使用者都可以手动调用该对象的Dispose方法释放资源，以保证相关资源及时回收，提高资源使用效率。
</p>

<p>
二者均可以进行资源回收，只是使用场景，调用时机和调用对象不同而已。
</p>
</div>
</div>
<div id="outline-container-orgddabd14" class="outline-2">
<h2 id="orgddabd14"><span class="section-number-2">2</span> Object.Finalize()简介</h2>
<div class="outline-text-2" id="text-2">
<p>
<code>Object.Finalize</code> 用于在运行时进行垃圾回收时， <b>回收非托管的资源</b> ，这点很重要。 他跟垃圾回收器有着紧密的联系。这里只是简单提下垃圾回收机制，下一篇文章再详细介绍。当一个对象被创建时，垃圾回收器会检查该对象有没有自定义 <code>Finalize()</code> 方法。如果已自定义，它会把这个对象标记为 <b>Finalizable</b> 并且将一个指向该对象的指针存入到 <code>finalization queue</code> 。当该对象需要被回收时，如果 <code>finalization queue</code> 中有指针指向该对象，垃圾回收器会将该对象从堆上拷贝至另外一个托管的结构体中， <code>finalization reachable table</code> 。 <b>重要</b> 在下一次垃圾回收时，垃圾回收器会创建一个单独的线程，调用所有在 <code>finalization reachable table</code> 中的对象的 <code>Finalize()</code> 方法。所以，Finalizeable的对象被完全回收需要 <b>至少两个</b> 垃圾回收周期。以下内容出自 <b>Pro C#5.0 and the .NET Framework</b> : 
</p>

<blockquote>
<p>
When you allocate an object onto the managed heap, the runtime automatically determines
whether your object supports a custom Finalize() method. If so, the object is marked as finalizable, and
a pointer to this object is stored on an internal queue named the finalization queue. The finalization
queue is a table maintained by the garbage collector that points to each and every object that must be
finalized before it is removed from the heap.
</p>

<p>
When the garbage collector determines it is time to free an object from memory, it examines each
entry on the finalization queue and copies the object off the heap to yet another managed structure
termed the finalization reachable table (often abbreviated as freachable, and pronounced “effreachable”).
At this point, a separate thread is spawned to invoke the Finalize() method for each object
on the freachable table at the next garbage collection. Given this, it will take, at the very least, two garbage
collections to truly finalize an object.
</p>
</blockquote>

<p>
但是开发人员不允许直接重载 <code>Finalize()</code> 方法，而是只能重载析构方法。我觉得主要是出于程序鲁棒性方面的考虑。下面是重载析构方法的样例代码。
</p>
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Override System.Object.Finalize() via finalizer syntax.</span>
<span style="color: #859900;">class</span> <span style="color: #268bd2;">MyResourceWrapper</span>
{
    ~MyResourceWrapper()
    {
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Clean up unmanaged resources here.</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Beep when destroyed (testing purposes only!)</span>
        Console.Beep();
    }
}
</pre>
</div>

<p>
编译后生成的IL代码：
</p>

<pre class="example">
.method family hidebysig virtual instance void Finalize() cil managed
{
  // Code size 13 (0xd)
  .maxstack 1
  .try
  {
    IL_0000: ldc.i4 0x4e20
    IL_0005: ldc.i4 0x3e8
    IL_000a: call
    void [mscorlib]System.Console::Beep(int32, int32)
    IL_000f: nop
    IL_0010: nop
    IL_0011: leave.s IL_001b
   } // end .try
   finally
   {
      IL_0013: ldarg.0
      IL_0014:
      call instance void [mscorlib]System.Object::Finalize()
      IL_0019: nop
      IL_001a: endfinally
   } // end handler
   IL_001b: nop
   IL_001c: ret
} // end of method MyResourceWrapper::Finalize
</pre>

<p>
由此可以看出，编译后，析构方法的代码会被拷贝至 <code>Finalize()</code> 方法的 <b>try</b> 块中，以防止自定义析构方法抛出异常影响垃圾回收器的正常运行。
</p>
</div>
</div>

<div id="outline-container-org26482bf" class="outline-2">
<h2 id="org26482bf"><span class="section-number-2">3</span> IDisosable.Dispose简介</h2>
<div class="outline-text-2" id="text-3">
<p>
接口 <code>IDisposable</code> 是对 <code>Object.Finalize()</code> 方法的补充，使用该接口可以及时地释放资源，提高资源使用效率。其原理也比较简单，垃圾回收不再由垃圾回收器负责，而是由调用方手动触发。当然触发得越及时，资源回收得越及时。假设现在有一个资源类 <code>MyResourceWrapper</code> 实现了该接口：
</p>

<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Implementing IDisposable.</span>
<span style="color: #859900;">class</span> <span style="color: #268bd2;">MyResourceWrapper</span> : <span style="color: #268bd2;">IDisposable</span>
{
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">The object user should call this method</span>
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">when they finish with the object.</span>
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">Dispose</span>()
    {
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Clean up unmanaged resources...</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Dispose other contained disposable objects...</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Just for a test.</span>
        Console.WriteLine(<span style="color: #2aa198;">"***** In Dispose! *****"</span>);
    }
}
</pre>
</div>

<p>
我们可以这样使用：
</p>
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">Main</span>(<span style="color: #268bd2;">string</span>[] <span style="color: #6c71c4;">args</span>)
{
    Console.WriteLine(<span style="color: #2aa198;">"***** Fun with Dispose *****\n"</span>);
    <span style="color: #268bd2;">MyResourceWrapper</span> <span style="color: #6c71c4;">rw</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">MyResourceWrapper</span> ();
    <span style="color: #859900;">try</span>
    {
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Use the members of rw.</span>
    }
    <span style="color: #859900;">finally</span>
    {
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Always call Dispose(), error or not.</span>
        rw.Dispose();
    }
}
</pre>
</div>

<p>
借助于C#的语法糖，我们也可以这样使用：
</p>
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">Main</span>(<span style="color: #268bd2;">string</span>[] <span style="color: #6c71c4;">args</span>)
{
    Console.WriteLine(<span style="color: #2aa198;">"***** Fun with Dispose *****\n"</span>);
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Dispose() is called automatically when the</span>
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">using scope exits.</span>
    <span style="color: #859900;">using</span>(<span style="color: #268bd2;">MyResourceWrapper</span> <span style="color: #6c71c4;">rw</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">MyResourceWrapper</span>())
    {
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Use rw object.</span>
    }
}
</pre>
</div>

<p>
编译器编译后生成的中间代码是一致的。
</p>
</div>
</div>
<div id="outline-container-org60d8dfc" class="outline-2">
<h2 id="org60d8dfc"><span class="section-number-2">4</span> 最佳实践</h2>
</div>
<div id="outline-container-orga5ead9b" class="outline-2">
<h2 id="orga5ead9b"><span class="section-number-2">5</span> 总结</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2017-07-10 Mon 21:29</p>
<p class="author">Author: Gao Song</p>
<p class="date">Created: 2017-07-12 Wed 20:04</p>
<p class="validation"></p>
</div>
</body>
</html>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/10/a-formalized-disposal-pattern/" rel="next" title="理解IDisposable.Dispose()和Object.Finalize()">
                <i class="fa fa-chevron-left"></i> 理解IDisposable.Dispose()和Object.Finalize()
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Jack Gao" />
          <p class="site-author-name" itemprop="name">Jack Gao</p>
           
              <p class="site-description motion-element" itemprop="description">Jack Gao's Blog</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">理解IDisposable.Dispose()和Object.Finalize()</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#orgf6ff82d"><span class="nav-number">1.1.</span> <span class="nav-text">1 引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#orgddabd14"><span class="nav-number">1.2.</span> <span class="nav-text">2 Object.Finalize()简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org26482bf"><span class="nav-number">1.3.</span> <span class="nav-text">3 IDisosable.Dispose简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org60d8dfc"><span class="nav-number">1.4.</span> <span class="nav-text">4 最佳实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#orga5ead9b"><span class="nav-number">1.5.</span> <span class="nav-text">5 总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Gao</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

  

</body>
</html>
